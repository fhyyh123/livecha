
#PROXY-START/

# Backend HTTP API
location ^~ /api/ {
    proxy_pass http://127.0.0.1:8080/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header REMOTE-HOST $remote_addr;
    add_header X-Cache $upstream_cache_status;
}

# Widget assets served by backend (stable + versioned)
location ^~ /chatlive/ {
    proxy_pass http://127.0.0.1:8080/chatlive/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-Cache $upstream_cache_status;
}

# WebSocket (agent)
location = /ws {
    proxy_pass http://127.0.0.1:8080/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600;
}

# WebSocket (public visitor)
location ^~ /ws/public {
    proxy_pass http://127.0.0.1:8080/ws/public;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600;
}

# SPA history 路由回退（React/Vite 必备）
location / {
    try_files $uri $uri/ /index.html;
}
# 允许 /visitor/embed 被第三方 iframe 引用（不要全站 SAMEORIGIN）
location = /visitor/embed {
  try_files $uri /index.html;
  add_header X-Frame-Options "" always;
  # 如你启用了 CSP，请至少确保 frame-ancestors 允许第三方（最简单是先不设置）
  # add_header Content-Security-Policy "frame-ancestors *" always;
}

#PROXY-END/